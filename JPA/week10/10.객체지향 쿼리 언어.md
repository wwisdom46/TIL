Chapter 10 "객체지향 쿼리 언어"
--

10장에서 배울 내용

- ✔️ **객체지향 쿼리 소개**
- ✔️ **JPQL**
- Criteria
- QueryDSL
- 네이티브 SQL - JPQL을 쓰더라도 특정 벤더에 종속적인 쿼리를 사용해야하는 경우 사용
- 객체지향 쿼리 심화

JPA는 다양한 쿼리방법을 지원한다.
JPQL로 웬만해선 다 해결되기는 한다.

## **객체지향 쿼리 소개**

### 1. JPQL(Java Persistence Query Language)

- JPA를 사용하면 엔티티 객체를 중심으로 개발이 가능하다
- 문제는 검색 쿼리
    - 검색을 할 때에도 테이블이 아닌 엔티티 객체를 대상으로 검색
    - 모든 DB 데이터를 객체로 변환해서 검색하는 것은 불가능
    - 애플리케이션이 필요한 데이터만 DB에서 불러오려면 결국 검색 조건이 포함된 SQL이 필요하다
- JPA는 SQL을 추상화한 JPQL이라는 객체 지향 쿼리 언어 제공
- SQL과 문법 유사
    - SELECT, FROM, WHERE, GROUP BY, HAVING, JOIN 지원
- JPQL은 엔티티 객체를 대상으로한 쿼리
- SQL은 데이터베이스 테이블을 대상으로한 쿼리

```java
// 검색
// 아래에서 m 은 Member 자체를 가져온다는 것을 의미
String jpql = "select m From Mermber m where m.name like '%hello%'";
List<Member> result = em.createQuery(jpql, Member.class)
				.getResultList();
```

```sql
-- 실행된 SQL
select
	m.id as id,
	m.age as age,
        m.username as USERNAME,
        m.team_id as TEAM_ID
from 
	Member m
where 
	m.name '%hello%'
```

- 테이블이 아닌 객체를 대상으로 검색하는 객체 지향 쿼리
- SQL을 추상화해서 특정 데이터베이스 SQL에 의존 X
- JPQL을 한마디로 정의하면 객체 지향 SQL

### 2. Criteria 소개

- JPQL은 String 이기 때문에  동적쿼리를 작성해야 할 때 어려움
- Criteria는 문자가 아닌 자바코드로 JPQL을 작성할 수 있음

```java
//Criteria 사용 준비
CriteriaBuilder cb = em.getCriteriaBuilder();
CriteriaQuery<Member> query = cb.createQuery(Member.class);

//루트 클래스 (조회를 시작할 클래스)
Root<Member> m = query.from(Member.class);
//쿼리 생성 
CriteriaQuery<Member> cq = query.select(m).where(cb.equal(m.get("username"), “kim”));
List<Member> resultList = em.createQuery(cq).getResultList();
```

- JPQL 빌더 역할
- JPA 공식 기능
- 복잡하고 유지보수가 어려우며 실무에서 잘 안씀
- Criteria 대신 QueryDSL 사용 권장

### 3. QueryDSL 소개

- 문자가 아닌 자바코드로 JPQL을 작성할 수 있음

```java
JPAFactoryQuery query = new JPAQueryFactory(em);
QMember m = QMember.member;
List<Member> list = 
		query.selectFrom(m)
		     .where(m.age.gt(18))
                     .orderBy(m.name.desc())
	             .fetch();
```

- JPQL 빌더 역할
- 컴파일 시점에 문법 오류를 찾을 수 잉ㅆ음
- 동적쿼리 작성이 편리함
- 오픈소스임 [http://querydsl.com/static/querydsl/5.0.0/reference/html_single/](http://querydsl.com/static/querydsl/5.0.0/reference/html_single/)
- 단순하고 쉬움. 실무 사용 권장

### 4. 네이티브SQL 소개

- JPA가 제공하는 SQL을 직접 사용하는 기능

```java
String sql =“SELECT ID, AGE, TEAM_ID, NAME FROM MEMBER WHERE NAME = ‘kim’";
List<Member> resultList = 
			em.createNativeQuery(sql, Member.class).getResultList();
```

- JPQL로 해결할 수 없는 특정 데이터베이스에 의존적인 기능
    - ex) 오라클 CONNECT BY, 특정 DB만 사용하는 SQL 힌트


### 5. JDBC 직접 사용, SpringJdbcTemplate 등

- JPA를 사용하면서 JDBC 커넥션을 직접 사용하거나, 스프링 JdbcTemplate, Mybatis 등을 함께 사용 가능
    - 단, 영속성 컨텍스트를 적절한 시점에 강제로 flush 필요
    - ex) JPA를 우회해서 SQL을 실행하기 직전에 영속성 컨텍스트 수동 flush

```java
Member member = new Member();
mermber.setUsername("mermber1");
em.persist(member);

em.flush(); // 아래에서 출력되기 위해선 강제로 flush

// JDBC 커텍션 직접 사용 예제
dbconnect.executeQuery("select * from member");
```
## JPQL(Java Persistence Query Language)
### 1. 기본 문법과 쿼리 API

- 객체지향 쿼리 언어다. 따라서 테이블을 대상으로 쿼리 하는 것이 아니라 **엔티티 객체를 대상으로 쿼리**한다.
- SQL을 추상화해서 특정데이터베이스 SQL에 의존하지 않는다.
- 결국 SQL로 변환된다.

![10-1.jpeg](./resources/10-1.jpeg)

### 2. 문법

- select_문 :: =
  select_절
  from_절
  [where_절]
  [groupby_절]
  [having_절]
  [orderby_절]

update_문 :: =

                      update_절  
                      [where_절]

delete_문 :: =

            delete_절 
            [where_절]
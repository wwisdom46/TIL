# **79. ê³¼ë„í•œ ë™ê¸°í™”ëŠ” í”¼í•˜ë¼**

> í•µì‹¬ ìš”ì•½
>
- êµì°© ìƒíƒœì™€ ë°ì´í„° í›¼ì†ì„ í”¼í•˜ë ¤ë©´ ë™ê¸°í™” ì˜ì—­ ì•ˆì—ì„œ ì™¸ê³„ì¸ ë©”ì†Œë“œë¥¼ ì ˆëŒ€ í˜¸ì¶œí•˜ì§€ ë§ì.
- ë™ê¸°í™” ì˜ì—­ ì•ˆì—ì„œì˜ ì‘ì—…ì€ ìµœì†Œí•œìœ¼ë¡œ ì¤„ì´ì.
- ê°€ë³€ í´ë˜ìŠ¤ë¥¼ ì„¤ê³„í•  ë•ŒëŠ” ìŠ¤ë ˆë“œ ì•ˆì „í•œ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì§€ì— ëŒ€í•œ ì—¬ë¶€ë¥¼ ê³ ë¯¼í•˜ì. ê·¸ë¦¬ê³  ì´ë¥¼ ë¬¸ì„œì— ëª…ê¸°í•˜ì.

ë™ê¸°í™”ëŠ” í”„ë¡œê·¸ë¨ ì•ˆì •ì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•´ ì¤‘ìš”í•˜ì§€ë§Œ, ê³¼ë„í•˜ê²Œ ì‚¬ìš©í•˜ë©´ ì„±ëŠ¥ ì €í•˜, êµì°© ìƒíƒœ, ì˜ˆì¸¡í•  ìˆ˜ ì—†ëŠ” ë™ì‘ ë“±ì˜ ë¬¸ì œë¥¼ ì•¼ê¸°í•  ìˆ˜ ìˆë‹¤.

ë™ê¸°í™”ëœ ì˜ì—­ì—ì„œëŠ” í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì œì–´ë¥¼ ì–‘ë„í•˜ë©´ ì•ˆ ëœë‹¤.

- ì˜ˆë¥¼ ë“¤ì–´, ì¬ì •ì˜í•  ìˆ˜ ìˆëŠ” ë©”ì†Œë“œ í˜¸ì¶œì´ë‚˜ í´ë¼ì´ì–¸íŠ¸ê°€ ì „ë‹¬í•œ í•¨ìˆ˜ ê°ì²´ í˜¸ì¶œì€ ë™ê¸°í™”ëœ ì˜ì—­ì—ì„œ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ë¬¸ì œë¥¼ ë°œìƒì‹œí‚¬ ìˆ˜ ìˆë‹¤.

# ì™¸ê³„ì¸ ë©”ì„œë“œ

ì‘ë‹µ ë¶ˆê°€ì™€ ì•ˆì „ ì‹¤íŒ¨ë¥¼ ìœ ë°œí•  ìˆ˜ ìˆëŠ” ë©”ì„œë“œ ì¦‰, ë™ê¸°í™”ëœ ì˜ì—­ì—ì„œ ì¬ì •ì˜í•  ìˆ˜ ìˆëŠ” ë©”ì„œë“œ í˜¹ì€ í´ë¼ì´ì–¸íŠ¸ê°€ ë„˜ê²¨ì¤€ í•¨ìˆ˜ ê°ì²´ ë“±ì„Â **ë™ê¸°í™”ëœ í´ë˜ìŠ¤ ê´€ì ì—ì„œ ì™¸ê³„ì¸ ë©”ì„œë“œë¼ê³  í•œë‹¤.**

ë™ê¸°í™”ëœ í´ë˜ìŠ¤ëŠ” ì™¸ê³„ì¸ ë©”ì„œë“œê°€ ë¬´ìŠ¨ ì¼ì„ í• ì§€ ì•Œì§€ ëª»í•˜ë©° í†µì œí•  ìˆ˜ë„ ì—†ê³ Â **ì™¸ê³„ì¸ ë©”ì„œë“œ**ê°€ í•˜ëŠ” ì¼ì— ë”°ë¼ ë™ê¸°í™”ëœ ì˜ì—­ì€ ì˜ˆì™¸ë¥¼ ì¼ìœ¼í‚¤ê±°ë‚˜, êµì°©ìƒíƒœì— ë¹ ì§€ê±°ë‚˜, ë°ì´í„°ë¥¼ í›¼ì†í•  ìˆ˜ë„ ìˆë‹¤.

**ë™ê¸°í™” ë¸”ë¡ ì•ˆì—ì„œ ì™¸ë¶€ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ëŠ” ì˜ëª»ëœ ì½”ë“œ**

```java
import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Set;

// ì–´ë–¤ ì§‘í•©(Set)ì„ ê°ì‹¼ ë˜í¼ í´ë˜ìŠ¤, í´ë˜ìŠ¤ì˜ í´ë¼ì´ì–¸íŠ¸ëŠ” ì§‘í•©ì— ì›ì†Œê°€ ì¶”ê°€ë˜ë©´ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆìŒ
public class ObservableSet<E> extends ForwardingSet<E> {

    public ObservableSet(Set<E> set) {
        super(set);
    }

    private final List<SetObserver<E>> observers = new ArrayList<>();

    public void addObserver(SetObserver<E> observer) {
        synchronized (observers) {
            observers.add(observer);
        }
    }
    
    public boolean removeObserver(SetObserver<E> observer) {
        synchronized (observers) {
            return observers.remove(observer);
        }
    }
    
    private void notifyElementAdded(E element) {
        synchronized (observers) {
            for(SetObserver<E> observer : observers) {
                observer.added(this, element);
            }
        }
    }
    
    @Override
    public boolean add(E element) {
        boolean added = super.add(element);
        if(added) {
            notifyElementAdded(element);
        }
        return added;
    }

    @Override
    public boolean addAll(Collection<? extends E> c) {
        boolean result = false;
        for (E element : c) {
            result |= add(element); // notifyElementAddedë¥¼ í˜¸ì¶œí•œë‹¤.
            // |= OR ì—°ì‚°ì. í•˜ë‚˜ë¼ë„ ì¶”ê°€ëœ ê²Œ ìˆìœ¼ë©´ true
        }
        return result;
    }
}

```

- Setì„ ê°ì‹¸ëŠ” ë˜í¼ í´ë˜ìŠ¤ì¸ ObservableSet í´ë˜ìŠ¤ëŠ” ê´€ì°°ì íŒ¨í„´ì„ êµ¬í˜„í•œ ê²ƒì´ë‹¤.
- í´ë¼ì´ì–¸íŠ¸ê°€ ì´ í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë©´ ì§‘í•©ì— ì›ì†Œê°€ ì¶”ê°€ë˜ë©´ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆë‹¤.
- ForwardingSet í´ë˜ìŠ¤ë¥¼ ì¬ì‚¬ìš©í•˜ì—¬ êµ¬í˜„í•˜ì˜€ìœ¼ë©°, addObserverì™€ removeObserver ë©”ì†Œë“œë¡œ êµ¬ë… ì‹ ì²­ ë° í•´ì§€ë¥¼ í•  ìˆ˜ ìˆë‹¤.

```java
@FunctionalInterface
public interface SetObserver<E> {
    // ObservableSetì— ì›ì†Œê°€ ì¶”ê°€ë˜ë©´ í˜¸ì¶œëœë‹¤.
    void added(ObservableSet<E> set, E element);
}
```

- ê´€ì°°ìë“¤ì€ SetObsever ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ì—¬ ê´€ì°°ì ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.
- added(ObservableSet<E> set, E element) ë©”ì„œë“œ í•˜ë‚˜ë§Œ ìˆëŠ” í•¨ìˆ˜í˜• ì¸í„°í˜ì´ìŠ¤
- ì›ì†Œê°€ ì¶”ê°€ë  ë•Œë§ˆë‹¤ ObservableSetì´ ì´ ë©”ì„œë“œë¥¼ í˜¸ì¶œ. ì´ë¥¼ í†µí•´ ê´€ì°°ìë“¤ì€ ì§‘í•©ì— ë³€í™”ê°€ ìƒê²¼ì„ ë•Œ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆë‹¤.

**0 ~ 99ê¹Œì§€ ì¶œë ¥í•˜ëŠ” ì˜ˆì œ**

```java
import java.util.HashSet;

public class Main {
    public static void main(String[] args) {
        ObservableSet<Integer> set =
                new ObservableSet<>(new HashSet<>());

        set.addObserver((s, e) -> System.out.println(e));
        /*
        ì»´íŒŒì¼ëŸ¬ëŠ” ì´ë ‡ê²Œ ìƒê°í•´ìš”:
				addObserverì˜ íŒŒë¼ë¯¸í„° íƒ€ì…ì€ SetObserver<E>
				SetObserver<E>ëŠ” ì¶”ìƒ ë©”ì„œë“œ added(ObservableSet<E> set, E element) í•˜ë‚˜ë¿
				ê·¸ëŸ¼ (s, e) -> System.out.println(e)ëŠ” ë°”ë¡œ added()ì˜ ë³¸ë¬¸ì´ë„¤?
				ğŸ‘‰ ë”°ë¼ì„œ ìë™ìœ¼ë¡œ ì´ ì½”ë“œê°€ ë§Œë“¤ì–´ì§:
        set.addObserver(new SetObserver<Integer>() {
		    @Override
		    public void added(ObservableSet<Integer> s, Integer e) {
		        System.out.println(e);
			    }
				});
        */

        for (int i = 0; i < 100; i++) {
            set.add(i);
        }
    }
}
```

ìœ„ ì½”ë“œëŠ” ì•„ë¬´ ì´ìƒì—†ì´ 0ë¶€í„° 99ê¹Œì§€ ì¶œë ¥

**ë¬¸ì œìƒí™© 1) ConcurrentModificationException ì´ ë°œìƒí•˜ëŠ” ì˜ˆì œ
: ë™ê¸°í™”ëœ ì»¬ë ‰ì…˜ì„ ìˆœíšŒí•˜ëŠ” ë™ì•ˆ ê·¸ ì»¬ë ‰ì…˜ì„ ìˆ˜ì •í•  ë•Œ ë°œìƒí•˜ëŠ” ì˜ˆì™¸**

```java
import java.util.HashSet;

public class Main {
    public static void main(String[] args) {
        ObservableSet<Integer> set =
                new ObservableSet<>(new HashSet<>());

        set.addObserver(new SetObserver<Integer>() {
            @Override
            public void added(ObservableSet<Integer> set, Integer element) {
                System.out.println(element);
                if (element == 23)
                    set.removeObserver(this);
            }
        });

        for (int i = 0; i < 100; i++) {
            set.add(i); // notifyElementAdded í˜¸ì¶œë˜ê³  ìˆìŒ
        }
    }
}
```

ìœ„ ì½”ë“œëŠ” ì•„ê¹Œ ë³´ì•˜ë˜ ì˜ˆì œì™€ ë‹¬ë¦¬ ConcurrentModificationExceptionì„ ë˜ì§„ë‹¤.

- ì§‘í•©ì— ì›ì†Œê°€ ì¶”ê°€í•˜ë©´ í•´ë‹¹ ì›ì†Œë¥¼ ì¶œë ¥í•˜ê³  ë§Œì•½ í•´ë‹¹ ì›ì†Œê°€ 23ì´ë¼ë©´ ê´€ì°°ìë¥¼ ì œê±°í•˜ëŠ” ë¡œì§ì„ êµ¬í˜„í•œ ì˜ˆì‹œì´ë‹¤.
    - ê·¸ëŸ¬ë‚˜ ë™ì‹œì— ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ê´€ì—¬í•˜ë©´ì„œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

**ë¬¸ì œÂ ë°œìƒ ê³¼ì • (ë‹¨ê³„ë³„ ì„¤ëª…)**

**Step 1: ObservableSetì˜ add ë©”ì„œë“œ í˜¸ì¶œ**

```java
**set.add(23);Â *//Â 23ì„Â ì¶”ê°€***
```

**Step 2: ObservableSet ë‚´ë¶€ì—ì„œ Observerë“¤ì—ê²Œ ì•Œë¦¼**

```java
public boolean add(E element) {
    boolean added = set.add(element);
    if (added) {
        notifyElementAdded(element); // ëª¨ë“  Observerì—ê²Œ ì•Œë¦¼
    }
    return added;
}

private void notifyElementAdded(E element) {
    for (SetObserver<E> observer : observers) { // ğŸš¨ ìˆœíšŒ ì¤‘!
        observer.added(this, element);
    }
}
```

**Step 3: Observerì˜ added ë©”ì„œë“œ ì‹¤í–‰**

```java
public void added(ObservableSet<Integer> set, Integer element) {
    System.out.println(element); // 23 ì¶œë ¥
    if (element == 23)
        set.removeObserver(this); // ğŸš¨ observers ë¦¬ìŠ¤íŠ¸ì—ì„œ ìì‹ ì„ ì œê±°!
}
```

### StepÂ 4: ConcurrentModificationException ë°œìƒ!

- notifyElementAddedÂ ë©”ì„œë“œê°€Â observersÂ ë¦¬ìŠ¤íŠ¸ë¥¼Â ìˆœíšŒí•˜ëŠ” ì¤‘
- Observerê°€Â removeObserver(this)ë¥¼Â í˜¸ì¶œí•˜ì—¬ ë¦¬ìŠ¤íŠ¸ë¥¼ ìˆ˜ì •
- **"ìˆœíšŒ ì¤‘ì¸Â ì»¬ë ‰ì…˜ì„ ìˆ˜ì •í–ˆë‹¤!"**Â â†’ ConcurrentModificationException

**ë¬¸ì œ ìƒí™© 2) ì‘ë‹µ ë¶ˆê°€(êµì°© ìƒíƒœ)**

```java
set.addObserver(new SetObserver<Integer>() {
		@Override
    public void added(ObservableSet<Integer> s, Integer e) {
        System.out.println(e);
        if (e == 23) {
            ExecutorService exec = Executors.newSingleThreadExecutor();
            try {
                exec.submit(() -> s.removeObserver(this)).get();
            } catch (ExecutionException | InterruptedException ex) {
                throw new AssertionError(ex);
            } finally {
                exec.shutdown();
            }
        }
    }
});
```

**ë¬¸ì œÂ ë°œìƒ ê³¼ì • (ë‹¨ê³„ë³„ ì„¤ëª…)**

**Step 1: ObservableSetì˜ add ë©”ì„œë“œ í˜¸ì¶œ**

```java
**set.add(23);Â *//Â 23ì„Â ì¶”ê°€***
```

**Step 2: ObservableSetì´ ë™ê¸°í™”ëœ ìƒíƒœë¡œ Observerë“¤ì—ê²Œ ì•Œë¦¼**

```java
private void notifyElementAdded(E element) {
    synchronized(observers) { // ğŸ”’ ë©”ì¸ ìŠ¤ë ˆë“œê°€ observers ë½ íšë“
        for (SetObserver<E> observer : observers) {
            observer.added(this, element); // Observerì˜ added ë©”ì„œë“œ í˜¸ì¶œ
        }
    } // ë½ í•´ì œ (í•˜ì§€ë§Œ ì•„ì§ í•´ì œë˜ì§€ ì•ŠìŒ! - ì™œëƒë©´ e == 23 êµ¬ë¬¸ì€ ì•„ì§ ëë‚˜ì§€ ì•Šì•˜ìœ¼ë‹ˆ) 
}
```

**StepÂ 3: Observerì˜Â added ë©”ì„œë“œì—ì„œÂ ìƒˆë¡œìš´ ìŠ¤ë ˆë“œ ìƒì„±**

```java
public void added(ObservableSet<Integer> s, Integer e) {
    System.out.println(e); // 23 ì¶œë ¥
    if (e == 23) {
        ExecutorService exec = Executors.newSingleThreadExecutor();
        // ìƒˆë¡œìš´ ìŠ¤ë ˆë“œ(Worker Thread) ìƒì„±
        // Worker Threadê°€ observers ë½ì„ ê¸°ë‹¤ë¦¼
        exec.submit(() -> s.removeObserver(this)).get();
    }
}
```

**StepÂ 4: êµì°©ìƒíƒœÂ ë°œìƒ! ğŸ’€**

- **ë©”ì¸ ìŠ¤ë ˆë“œ**:Â observersÂ ë½ì„Â ê°€ì§€ê³  ìˆê³ ,Â exec.submit(...).get()ì—ì„œ Worker Thread ì™„ë£Œë¥¼ ê¸°ë‹¤ë¦¼
- **WorkerÂ Thread**:Â removeObserver()ë¥¼ í˜¸ì¶œí•˜ë ¤ í•˜ì§€ë§ŒÂ observersÂ ë½ì„ íšë“í•˜ì§€ ëª»í•´Â ëŒ€ê¸°
- **ê²°ê³¼**: ì„œë¡œë¥¼ ë¬´í•œì • ê¸°ë‹¤ë¦¬ëŠ” êµì°©ìƒíƒœ!

## í•´ê²°ë°©ì•ˆ

**ì™¸ê³„ì¸ ë©”ì„œë“œ í˜¸ì¶œì„ ë™ê¸°í™” ë¸”ë¡ ë°”ê¹¥ìœ¼ë¡œ ì˜®ê¸°ë©´ ëœë‹¤.  (ì™¸ë¶€ ì½”ë“œÂ í˜¸ì¶œ ì „ì— ë½ í•´ì œ)**

notifyElementAdded2 ë©”ì„œë“œì—ì„œë¼ë©´ ê´€ì°°ì ë¦¬ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•´ ì“°ë©´ ë½ ì—†ì´ë„ ì•ˆì „í•˜ê²Œ ìˆœíšŒí•  ìˆ˜ ìˆë‹¤.

ì´ ë°©ì‹ì„ ì ìš©í•˜ë©´ ì•ì„œì˜ ì²«ë²ˆì§¸ ì‹œë„, ë‘ë²ˆì§¸ ì‹œë„ì—ì„œ ë°œìƒí•œ ì˜ˆì™¸, êµì°©ìƒíƒœ ì¦ìƒì´ ì‚¬ë¼ì§„ë‹¤.

```java
private void notifyElementAdded2(E element) {
    List<SetObserver<E>> snapshot = null;
    
    synchronized (observers) {
        snapshot = new ArrayList<>(observers);
    }

    for (SetObserver<E> observer : snapshot)
        observer.added(this, element);
}
```

ì´ì²˜ëŸ¼ ë™ê¸°í™” ì˜ì—­ ë°”ê¹¥ì—ì„œ í˜¸ì¶œë˜ëŠ” ì™¸ê³„ì¸ ë©”ì„œë“œë¥¼ ì—´ë¦° í˜¸ì¶œ(open call)ì´ë¼ê³  í•œë‹¤.

ì™¸ê³„ì¸ ë©”ì„œë“œëŠ” ì–¼ë§ˆë‚˜ ì˜¤ë˜ ì‹¤í–‰ë ì§€ ì•Œ ìˆ˜ ì—†ëŠ”ë°, ë™ê¸°í™” ì˜ì—­ ì•ˆì—ì„œ í˜¸ì¶œëœë‹¤ë©´ ê·¸ë™ì•ˆ ë‹¤ë¥¸ ìŠ¤ë ˆë“œëŠ” ë³´í˜¸ëœ ìì›ì„ ì‚¬ìš©í•˜ì§€ ëª»í•˜ê³  ëŒ€ê¸°í•´ì•¼ë§Œí•œë‹¤. ë”°ë¼ì„œ ì—´ë¦° í˜¸ì¶œì€ ì‹¤í–‰ ë°©ì§€ íš¨ê³¼ ì™¸ì—ë„ ë™ì‹œì„± íš¨ìœ¨ì„ í¬ê²Œ ê°œì„ í•´ì¤€ë‹¤.

## ë” ë‚˜ì€ í•´ê²°ë°©ì•ˆ

ìë°”ì˜ ë™ì‹œì„± ì»¬ë ‰ì…˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜Â CopyOnWriteArrayListê°€ ì •í™•íˆ ì´ ëª©ì ìœ¼ë¡œ íŠ¹ë³„íˆ ì„¤ê³„ë˜ì—ˆë‹¤.

ArrayListë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ë¡œ, ë‚´ë¶€ë¥¼ ë³€ê²½í•˜ëŠ” ì‘ì—…ì€ í•­ìƒ ê¹¨ë—í•œ ë³µì‚¬ë³¸ì„ ë§Œë“¤ì–´ ìˆ˜í–‰í•˜ë„ë¡ êµ¬í˜„í–ˆë‹¤.

ë‚´ë¶€ì˜ ë°°ì—´ì€ ì ˆëŒ€ ìˆ˜ì •ë˜ì§€ ì•Šìœ¼ë‹ˆ ìˆœíšŒí• ë•Œ ë½ì´ í•„ìš” ì—†ì–´ ë§¤ìš° ë¹ ë¥´ë‹¤.

```java
private final List<SetObserver<E>> observers = new CopyOnWriteArrayList<>();

public void addObserver(SetObserver<E> observer) {
    observers.add(observer);
}

public boolean removeObserver(SetObserver<E> observer) {
    return observers.remove(observer);
}

private void notifyElementAdded(E element) {
    for (SetObserver<E> observer : observers)
        observer.added(this, element);
```

## ì •ë¦¬

ìë°”ì˜ ë™ê¸°í™” ë¹„ìš©ì€ ë¹ ë¥´ê²Œ ë‚®ì•„ì ¸ì™”ë‹¤. í•˜ì§€ë§Œ ê³¼ë„í™˜ ë™ê¸°í™”ë¥¼ í”¼í•˜ëŠ” ì¼ì€ ì˜¤íˆë ¤ ê³¼ê±° ì–´ëŠ ë•Œë³´ë‹¤ ì¤‘ìš”í•˜ë‹¤.

ê³¼ë„í•œ ë™ê¸°í™”ê°€ ì´ˆë˜í•˜ëŠ” ì§„ì§œ ë¹„ìš©ì€ ë½ì„ ì–»ëŠ”ë° ë“œëŠ” CPU ì‹œê°„ì´ ì•„ë‹Œ, 'ê²½ìŸí•˜ëŠë¼ ë‚­ë¹„í•˜ëŠ” ì‹œê°„, ì¦‰ ë³‘ë ¬ë¡œ ì‹¤í–‰í•  ê¸°íšŒë¥¼ ìƒê³ , ëª¨ë“  ì½”ì–´ê°€ ë©”ëª¨ë¦¬ë¥¼ ì¼ê´€ë˜ê²Œ ë³´ê¸° ìœ„í•œ ì§€ì—°ì‹œê°„'ì´ ì§„ì§œ ë¹„ìš©ì´ë‹¤.

- í´ë¼ì´ì–¸íŠ¸ê°€ ë„˜ê²¨ì¤€ í•¨ìˆ˜ëŠ” ë™ê¸°í™” ì˜ì—­ ì•ˆì—ì„œ í˜¸ì¶œí•˜ë©´ ì•ˆëœë‹¤.
- ë™ê¸°í™” ì˜ì—­ ì•ˆì—ì„œì˜ ì‘ì—…ì€ ìµœì†Œí•œìœ¼ë¡œ ì¤„ì´ì.
- ê°€ë³€ í´ë˜ìŠ¤ë¥¼ ì„¤ê³„í•  ë•ŒëŠ” ìŠ¤ìŠ¤ë¡œ ë™ê¸°í™”ê°€ í•„ìš”í•œì§€ ê³ ë¯¼í•´ì•¼í•œë‹¤.